# arbit-ffi

Language-agnostic C FFI bindings for Arbit.

## Overview

This crate provides a pure C-compatible Foreign Function Interface (FFI) layer for Arbit. It exposes the core functionality through standard C types and functions, making it consumable by any language that supports C FFI.

## Architecture

```
arbit-ffi/
├── cbindgen.toml          # Configuration for C header generation
├── include/               # Generated C headers (gitignored)
│   └── arbit_ffi.h
├── scripts/
│   └── generate-header.sh # Script to generate C header
└── src/
    └── lib.rs             # FFI implementation
```

## Header Generation

The C header is generated using `cbindgen` and should be regenerated whenever the FFI interface changes:

```bash
./scripts/generate-header.sh
```

This creates `include/arbit_ffi.h` with all public C-compatible types and functions.

## API Convention

All exported symbols use the `arbit_` prefix:

- **Types**: `ArbitCameraFrame`, `ArbitImuSample`, etc.
- **Functions**: `arbit_context_create()`, `arbit_ingest_frame()`, etc.
- **Enums**: `ArbitPixelFormat`, `ArbitTrackStatus`, etc.

## Memory Management

- Context creation: `arbit_context_create()` returns an opaque handle
- Context destruction: `arbit_context_destroy(handle)` frees all resources
- Data ownership: The FFI layer does not take ownership of input buffers
- Thread safety: Each context is independent; concurrent access requires external synchronization

## Testing

Run the FFI tests:

```bash
cargo test -p arbit-ffi
```

## Build Outputs

- **Library**: `libarbit_ffi.a` (static) or `libarbit_ffi.so` (dynamic)
- **Header**: `include/arbit_ffi.h` (generated by script)

## Dependencies

- `arbit-core`: Core math and algorithms
- `arbit-engine`: Processing pipeline
- `arbit-providers`: Platform-specific frame providers

## Development

When adding new FFI functions:

1. Add the function in `src/lib.rs` with `#[no_mangle]` and `extern "C"`
2. Use `#[repr(C)]` for all structs passed across FFI
3. Regenerate the header: `./scripts/generate-header.sh`
4. Update consuming crates (e.g., `arbit-swift`)

